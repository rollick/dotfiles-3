#!/bin/zsh
local ENV_NAME
local TOPLEVEL="$(git rev-parse --show-toplevel 2>/dev/null)"

if [[ -n "${TOPLEVEL}" ]]; then
	# Get required virtual environment
	if [[ -f "${TOPLEVEL}/.venv" ]]; then
		ENV_NAME=$(< "${TOPLEVEL}/.venv")
	else
		ENV_NAME="${TOPLEVEL:t}"
	fi

	# Activate virtual environment
	if [[ "${VIRTUAL_ENV}" != "${WORKON_HOME}/${ENV_NAME}" ]]; then
		if [[ -e "${WORKON_HOME}/${ENV_NAME}/bin/activate" ]]; then
			workon --no-cd "$ENV_NAME" && export CD_VIRTUAL_ENV="${ENV_NAME}"
		fi
	fi
elif [[ -n "${CD_VIRTUAL_ENV}" ]]; then
	deactivate && unset CD_VIRTUAL_ENV
fi
